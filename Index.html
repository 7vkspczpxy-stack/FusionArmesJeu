<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fusion d'Armes</title>
    <!-- Chargement de Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Configuration des polices et des classes Tailwind -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fond sombre */
        }
        .app-container {
            max-width: 420px; /* Taille typique d'un t√©l√©phone */
            height: 100vh;
            margin: auto;
            display: flex;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0 0 0 / 0.5);
            background-color: #161b22; /* Conteneur de l'application */
        }
        .game-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            aspect-ratio: 1 / 1; /* Carr√© parfait */
            gap: 4px;
        }
        .weapon-item {
            /* Utilisation de 'grab' pour le curseur sur desktop, le toucher g√®re l'interaction sur mobile */
            cursor: grab; 
            user-select: none;
            transition: transform 0.1s;
            touch-action: none; /* Crucial pour un glisser-d√©poser tactile fluide */
        }
        .dragging {
            opacity: 0.8;
            transform: scale(1.1);
            position: absolute;
            z-index: 50;
            box-shadow: 0 10px 20px rgba(0 0 0 / 0.5);
            /* S'assurer que le glisser-d√©poser est fluide m√™me hors du conteneur parent */
        }
        .ai-button {
            transition: all 0.2s;
            box-shadow: 0 4px #7c3aed; 
        }
        .ai-button:active {
            box-shadow: 0 2px #7c3aed;
            transform: translateY(2px);
        }
        .overflow-x-auto::-webkit-scrollbar {
            height: 8px;
        }
        .overflow-x-auto::-webkit-scrollbar-thumb {
            background-color: #4a5568; 
            border-radius: 4px;
        }
        .overflow-x-auto::-webkit-scrollbar-track {
            background-color: #1a202c; 
        }
    </style>
    <!-- Importation des biblioth√®ques Firebase et Tone.js -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Variables globales fournies par l'environnement
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // D√©claration des variables Firebase dans la port√©e du module
        let app, db, auth;
        window.userId = null;
        
        // --- Initialisation et Authentification Firebase ---
        window.initFirebase = async () => {
            try {
                if (!firebaseConfig) {
                    console.error("Firebase config non trouv√©e. Utilisation de l'√©tat local uniquement.");
                    // L'√©tat est d√©j√† true, pas besoin de le red√©finir
                    return;
                }
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        window.userId = user.uid; // Met √† jour la variable globale
                        console.log("Authentifi√© avec l'ID utilisateur:", window.userId);
                    } else {
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                    }
                    // window.isAuthReady est d√©j√† true
                    window.loadAndListen(); // On lance l'√©coute des donn√©es d√®s que l'ID utilisateur est pr√™t
                });
            } catch (error) {
                console.error("Erreur lors de l'initialisation de Firebase:", error);
                // L'√©tat est d√©j√† true, pas besoin de le red√©finir
            }
        };

        // --- Gestion de l'√©tat Firestore (Donn√©es Priv√©es Solo) ---
        
        // Chemin de l'√©tat de jeu priv√© (Sauvegarde solo)
        const privateGameStatePath = () => {
            if (!window.userId) return null; 
            // /artifacts/{appId}/users/{userId}/weapon_merger_game/game_state
            return doc(db, `artifacts/${appId}/users/${window.userId}/weapon_merger_game`, 'game_state');
        };

        // Sauvegarde l'√©tat actuel du jeu solo
        window.saveGameState = async (state) => {
            if (!db || !window.userId) return; 
            try {
                const path = privateGameStatePath();
                await setDoc(path, state);
            } catch (error) {
                console.error("Erreur de sauvegarde de l'√©tat du jeu:", error);
            }
        };

        window.unsubscribeSnapshot = null;

        window.loadAndListen = () => {
            if (!db || !window.userId) return; 

            // D√©sabonner de l'ancien listener si pr√©sent
            if (window.unsubscribeSnapshot) {
                window.unsubscribeSnapshot();
                window.unsubscribeSnapshot = null;
            }
            
            const path = privateGameStatePath();
            if (!path) return;

            window.unsubscribeSnapshot = onSnapshot(path, (docSnapshot) => {
                let shouldRender = true; // Rendu par d√©faut

                if (docSnapshot.exists()) {
                    const loadedState = docSnapshot.data();
                    // On ne rend pas si l'√©tat local est d√©j√† √† jour (pour √©viter le clignotement lors de la sauvegarde locale)
                    // if (JSON.stringify(window.gameState) === JSON.stringify(loadedState)) shouldRender = false;

                    window.gameState = loadedState;
                    console.log("√âtat du jeu solo mis √† jour par Firestore:", window.gameState);
                } else {
                    // Initialiser si aucune donn√©e n'existe en mode priv√©
                    if (window.gameState.userName === '') { // Seulement si l'utilisateur n'a pas encore entr√© de nom
                        console.log("Pas d'√©tat de jeu trouv√©, initialisation...");
                        window.gameState = window.initialState;
                        window.gameState.view = 'name_input';
                    }
                    window.saveGameState(window.gameState); 
                }
                
                if (shouldRender) window.renderApp();
                
                // D√©marrer l'intervalle de spawn si on est dans la vue 'game'
                if (window.gameState.view === 'game' && !window.gameState.stats.spawnIntervalId) {
                    window.startSpawnInterval();
                }
            }, (error) => {
                console.error("Erreur d'√©coute de l'√©tat du jeu:", error);
            });
        };

        // Initialiser Firebase au chargement
        window.addEventListener('load', window.initFirebase);
    </script>
    <script src="https://unpkg.com/tone@14.8.49/build/Tone.js"></script>
</head>
<body class="p-0 m-0 overflow-hidden">
    <!-- D√©finir les variables globales avant tout autre script. -->
    <script>
        // PASSAGE CL√â : on d√©finit isAuthReady √† true pour d√©marrer imm√©diatement
        window.isAuthReady = true; 
        window.aiModalContent = null; 
    </script>

    <div id="app" class="app-container">
        <!-- Le contenu sera inject√© ici par JavaScript -->
        <!-- Suppression du message "Connexion s√©curis√©e en cours..." -->
    </div>
    
    <!-- Pied de page du cr√©ateur -->
    <footer class="p-2 text-center text-xs text-gray-500 bg-gray-900 border-t border-gray-700">
        Cr√©ateur: Enzo
    </footer>

    <!-- Modal pour les r√©ponses de l'IA -->
    <div id="ai-modal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50">
        <div class="bg-gray-800 p-6 rounded-xl w-full max-w-md shadow-2xl border border-purple-700">
            <h3 id="ai-modal-title" class="text-2xl font-bold text-yellow-400 mb-4"></h3>
            <div id="ai-modal-body" class="text-gray-200 text-sm overflow-y-auto max-h-80 mb-6 whitespace-pre-wrap"></div>
            <button onclick="closeAIModal()" class="w-full p-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">Fermer</button>
        </div>
    </div>

    <script>
        // --- Configuration de l'API Gemini ---
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=';
        const apiKey = ""; 

        async function fetchGeminiResponse(userQuery, systemPrompt) {
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }], 
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            const apiUrl = `${GEMINI_API_URL}${apiKey}`;
            let response, result;

            for (let i = 0; i < 3; i++) { 
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.ok) {
                        result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "Erreur : La r√©ponse de l'IA est vide.";
                        return text;
                    } else if (response.status === 429) {
                        const delay = Math.pow(2, i) * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                    } else {
                        return `Erreur API (${response.status}): ${response.statusText}`;
                    }
                } catch (error) {
                    console.error("Erreur r√©seau ou parsing:", error);
                    return "Erreur r√©seau: Impossible de contacter l'IA.";
                }
            }
            return "√âchec de l'appel API apr√®s plusieurs tentatives.";
        }
        
        // --- Utilitaires de Modal AI ---
        const openAIModal = (title, content) => {
            const modal = document.getElementById('ai-modal');
            document.getElementById('ai-modal-title').textContent = title;
            document.getElementById('ai-modal-body').textContent = content; 
            modal.classList.remove('hidden');
        };

        const closeAIModal = () => {
            document.getElementById('ai-modal').classList.add('hidden');
        };


        // --- Donn√©es et Configuration du Jeu ---

        const WEAPON_TYPES = [
            { level: 1, name: "Dague rouill√©e", rarity: "Commune", color: "text-gray-400", bg: "bg-gray-700", icon: "üó°Ô∏è", xp: 10 },
            { level: 2, name: "√âp√©e en fer", rarity: "Commune", color: "text-slate-400", bg: "bg-slate-700", icon: "‚öîÔ∏è", xp: 30 },
            { level: 3, name: "Hache de guerre", rarity: "Peu Commune", color: "text-green-400", bg: "bg-green-700", icon: "ü™ì", xp: 90 },
            { level: 4, name: "Arc long", rarity: "Peu Commune", color: "text-lime-400", bg: "bg-lime-700", icon: "üèπ", xp: 270 },
            { level: 5, name: "Lance runique", rarity: "Rare", color: "text-blue-400", bg: "bg-blue-700", icon: "üî±", xp: 810 },
            { level: 6, name: "Katana", rarity: "Rare", color: "text-indigo-400", bg: "bg-indigo-700", icon: "üî™", xp: 2430 },
            { level: 7, name: "Marteau de Thor", rarity: "√âpique", color: "text-purple-400", bg: "bg-purple-700", icon: "üî®", xp: 7290 },
            { level: 8, name: "Sceptre cosmique", rarity: "L√©gendaire", color: "text-yellow-400", bg: "bg-yellow-700", icon: "‚ú®", xp: 21870 }
        ];

        const GRID_SIZE = 9; 
        const MAX_INVENTORY_SIZE = 5;

        // √âtat initial du jeu
        window.initialState = {
            view: 'name_input', 
            userName: '', 
            lastMergedWeapon: null, 
            level: 1,
            xp: 0,
            xpToNextLevel: 100,
            money: 100, 
            grid: Array(GRID_SIZE).fill(null), 
            inventory: [], 
            stats: {
                spawnSpeed: 5000, 
                rareChance: 0.1, 
                spawnIntervalId: null, 
            },
            musicVolume: 0.5, 
            isMusicPlaying: false,
            aiAnalysisHistory: {} 
        };

        window.gameState = JSON.parse(JSON.stringify(window.initialState)); 
        
        // --- Impl√©mentation de la Musique (Tone.js) ---
        let synth = null;
        let panner = null;
        let loop = null;

        const setupMusic = () => {
            if (synth) return;

            const freeverb = new Tone.Freeverb(0.01, 5000).toDestination();
            panner = new Tone.Panner(0.0).connect(freeverb);

            synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "square" },
                envelope: {
                    attack: 0.5,
                    decay: 0.1,
                    sustain: 0.9,
                    release: 2
                }
            }).connect(panner);

            const chords = ["C3", "G3", "A3", "F3"];
            let chordIndex = 0;

            loop = new Tone.Loop(time => {
                const chord = chords[chordIndex % chords.length];
                synth.triggerAttackRelease(chord, "4n", time);
                chordIndex++;
            }, "2n").start(0); 

            Tone.Transport.bpm.value = 60;
            Tone.Transport.start();

            Tone.Destination.volume.value = Tone.gainToDb(window.gameState.musicVolume);
            window.gameState.isMusicPlaying = true;
        };

        window.startMusic = () => {
            if (Tone.context.state !== 'running') {
                Tone.context.resume();
            }
            if (!synth) {
                setupMusic();
            }
            window.gameState.isMusicPlaying = true;
            window.renderApp();
        };
        
        window.toggleMusic = () => {
            if (!synth) {
                window.startMusic();
            } else {
                if (Tone.Transport.state === 'started') {
                    Tone.Transport.pause();
                    window.gameState.isMusicPlaying = false;
                } else {
                    Tone.Transport.start();
                    window.gameState.isMusicPlaying = true;
                }
            }
            window.saveGameState(window.gameState);
            window.renderApp();
        };


        const updateMusicVolume = (newVolume) => {
            window.gameState.musicVolume = newVolume;
            if (Tone.Destination) {
                Tone.Destination.volume.value = Tone.gainToDb(newVolume);
            }
            window.saveGameState(window.gameState);
            window.renderApp();
        };
        
        // --- Fonctions Utilitaires ---
        
        const generateId = (length = 6) => {
            let result = '';
            const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            const charactersLength = characters.length;
            for (let i = 0; i < length; i++) {
                result += characters.charAt(Math.floor(Math.random() * charactersLength));
            }
            return result;
        };
        
        const getWeaponData = (level) => {
            const index = Math.min(level, WEAPON_TYPES.length) - 1;
            const baseData = WEAPON_TYPES[index];

            if (level > WEAPON_TYPES.length) {
                const lastType = WEAPON_TYPES[WEAPON_TYPES.length - 1];
                return {
                    level: level,
                    name: `${lastType.name} (√âlev√© ${level})`,
                    rarity: "Ultime",
                    color: "text-red-400", 
                    bg: "bg-red-700", 
                    icon: "üî•",
                    xp: lastType.xp * (level - WEAPON_TYPES.length + 1) * 3 
                };
            }
            return baseData || WEAPON_TYPES[0];
        };

        const spawnWeapon = (level = 1) => {
            if (window.gameState.inventory.length >= MAX_INVENTORY_SIZE) return;

            let maxLevel = Math.min(3, Math.floor(window.gameState.level / 5) + 1);
            let weaponLevel = level; 

            if (weaponLevel === 1) { 
                let rarityRoll = Math.random();

                if (rarityRoll < window.gameState.stats.rareChance && maxLevel > 1) {
                    weaponLevel = Math.min(maxLevel, Math.floor(Math.random() * maxLevel) + 2);
                } else {
                    weaponLevel = 1;
                }
            }
            
            const newWeapon = { ...getWeaponData(weaponLevel), id: generateId(10) };
            window.gameState.inventory = [...window.gameState.inventory, newWeapon];
        };

        window.startSpawnInterval = () => {
            if (window.gameState.stats.spawnIntervalId) {
                clearInterval(window.gameState.stats.spawnIntervalId);
            }
            const intervalId = setInterval(() => {
                spawnWeapon();
                window.saveGameState(window.gameState); 
                window.renderApp(); 
            }, window.gameState.stats.spawnSpeed);
            window.gameState.stats.spawnIntervalId = intervalId;
            console.log("Intervalle de spawn d√©marr√©:", intervalId);
        };
        
        const stopSpawnInterval = () => {
            if (window.gameState.stats.spawnIntervalId) {
                clearInterval(window.gameState.stats.spawnIntervalId);
                window.gameState.stats.spawnIntervalId = null;
                console.log("Intervalle de spawn stopp√©.");
            }
        };

        const addXP = (amount) => {
            window.gameState.xp += amount;
            while (window.gameState.xp >= window.gameState.xpToNextLevel) {
                window.gameState.xp -= window.gameState.xpToNextLevel;
                window.gameState.level += 1;
                window.gameState.xpToNextLevel = Math.floor(window.gameState.xpToNextLevel * 1.5); 
            }
            window.saveGameState(window.gameState);
        };

        // --- Logique de Glisser-D√©poser (Drag and Drop) ---

        let draggingWeaponId = null;
        let sourceIndex = null; 
        let isDragging = false;
        
        // Fonction utilitaire pour obtenir la position du client (souris ou toucher)
        const getClientPos = (event) => {
            if (event.touches && event.touches.length > 0) {
                return { clientX: event.touches[0].clientX, clientY: event.touches[0].clientY };
            }
            if (event.changedTouches && event.changedTouches.length > 0) {
                return { clientX: event.changedTouches[0].clientX, clientY: event.changedTouches[0].clientY };
            }
            return { clientX: event.clientX, clientY: event.clientY };
        };


        const startDrag = (event, id, source, index) => {
            if (event.type === 'touchstart' || event.type === 'touchmove' || event.type === 'touchend') {
                event.preventDefault();
            } else if (event.type !== 'mousedown') {
                event.preventDefault();
            }

            window.startMusic();
            draggingWeaponId = id;
            sourceIndex = index;

            const originalWeaponElement = event.currentTarget;
            const clone = originalWeaponElement.cloneNode(true);
            clone.id = 'drag-clone';
            clone.style.position = 'absolute';
            clone.style.pointerEvents = 'none'; 
            clone.classList.add('dragging');
            document.getElementById('app').appendChild(clone);

            originalWeaponElement.style.visibility = 'hidden';

            isDragging = true;
            
            updateDragPosition(event);

            document.addEventListener('mousemove', updateDragPosition);
            document.addEventListener('mouseup', dropWeapon);
            document.addEventListener('touchmove', updateDragPosition, { passive: false });
            document.addEventListener('touchend', dropWeapon);
        };

        const updateDragPosition = (event) => {
            if (!isDragging) return;
            if (event.type === 'touchmove') {
                event.preventDefault(); 
            }

            const clone = document.getElementById('drag-clone');
            if (!clone) return;

            const { clientX, clientY } = getClientPos(event);

            const container = document.getElementById('app');
            const containerRect = container.getBoundingClientRect();
            
            const offsetX = clone.offsetWidth / 2;
            const offsetY = clone.offsetHeight / 2;

            clone.style.left = `${clientX - containerRect.left - offsetX}px`;
            clone.style.top = `${clientY - containerRect.top - offsetY}px`;
        };

        const dropWeapon = (event) => {
            if (!isDragging) return;
            isDragging = false;
            
            const clone = document.getElementById('drag-clone');
            if (clone) clone.remove();
            
            const originalWeaponElement = document.querySelector(`.weapon-item[data-id="${draggingWeaponId}"]`);
            if (originalWeaponElement) originalWeaponElement.style.visibility = 'visible';

            document.removeEventListener('mousemove', updateDragPosition);
            document.removeEventListener('mouseup', dropWeapon);
            document.removeEventListener('touchmove', updateDragPosition);
            document.removeEventListener('touchend', dropWeapon);

            const { clientX, clientY } = getClientPos(event);

            if (clientX === undefined || clientY === undefined) return;

            const targetElement = document.elementFromPoint(clientX, clientY);
            
            if (targetElement) {
                const targetGridSlot = targetElement.closest('.grid-slot');
                const targetGridIndex = targetGridSlot ? targetGridSlot.dataset.index : undefined;
                
                if (targetGridIndex !== undefined) {
                    handleDropOnGrid(parseInt(targetGridIndex));
                } else {
                    if (sourceIndex === 'inventory') {
                        const emptyIndex = window.gameState.grid.findIndex(slot => slot === null);
                        if (emptyIndex !== -1) {
                            handleDropOnGrid(emptyIndex);
                        }
                    }
                }
            }
            
            draggingWeaponId = null;
            sourceIndex = null;
            window.renderApp();
        };

        const handleDropOnGrid = (targetIndex) => {
            const targetWeapon = window.gameState.grid[targetIndex];
            
            let sourceWeapon;
            if (sourceIndex === 'inventory') {
                sourceWeapon = window.gameState.inventory.find(w => w.id === draggingWeaponId);
            } else {
                const sourceIndexInt = parseInt(sourceIndex);
                sourceWeapon = window.gameState.grid[sourceIndexInt];
            }

            if (!sourceWeapon) return;

            // 1. Logique de fusion 
            if (targetWeapon && sourceWeapon.level === targetWeapon.level) {
                performMerge(sourceWeapon.level, targetIndex, sourceIndex, sourceWeapon.id);
            }
            // 2. Logique de placement/d√©placement vers un emplacement vide
            else if (targetWeapon === null) {
                if (sourceIndex === 'inventory') {
                    window.gameState.inventory = window.gameState.inventory.filter(w => w.id !== draggingWeaponId);
                    window.gameState.grid[targetIndex] = sourceWeapon;
                    showMessage(`Arme plac√©e dans la grille.`);
                } else {
                    const sourceIndexInt = parseInt(sourceIndex);
                    // √âchange direct si la source et la cible sont des emplacements de grille
                    window.gameState.grid[targetIndex] = sourceWeapon;
                    window.gameState.grid[sourceIndexInt] = null;
                    showMessage(`Arme d√©plac√©e.`);
                }
            } else {
                showMessage('Fusion impossible ou emplacement occup√©.');
            }

            window.saveGameState(window.gameState);
        };
        
        const performMerge = (level, targetIndex, sourceArea, sourceIdOrIndex) => {
            const nextLevel = level + 1;
            const newWeaponData = { ...getWeaponData(nextLevel), id: generateId(10) };
            
            window.gameState.grid[targetIndex] = newWeaponData;
            window.gameState.lastMergedWeapon = newWeaponData; 

            if (sourceArea === 'inventory') {
                window.gameState.inventory = window.gameState.inventory.filter(w => w.id !== sourceIdOrIndex);
            } else { 
                window.gameState.grid[parseInt(sourceArea)] = null;
            }

            const mergedWeapon = getWeaponData(level);
            addXP(mergedWeapon.xp);
            window.gameState.money += mergedWeapon.level * 5; 

            const numSpawns = nextLevel; 
            for (let i = 0; i < numSpawns; i++) {
                spawnWeapon(1); 
            }
            
            showMessage(`Fusion r√©ussie! ${newWeaponData.name} cr√©√©e. (+${mergedWeapon.xp} XP, +${mergedWeapon.level * 5} üí∞, +${numSpawns} üó°Ô∏è g√©n√©r√©es)`);
        };

        // --- Fonctions Gemini AI ---

        // Fonction 1: Analyse strat√©gique de la derni√®re arme fusionn√©e
        window.analyzeLastWeapon = async () => {
            if (!window.gameState.lastMergedWeapon) { 
                showMessage("Vous devez d'abord fusionner deux armes pour obtenir une analyse !");
                return;
            }
            
            const cost = 50;
            if (window.gameState.money < cost) {
                showMessage(`Il vous faut ${cost} üí∞ pour l'analyse d'expert.`);
                return;
            }

            window.gameState.money -= cost;
            window.saveGameState(window.gameState);
            window.renderApp(); 

            const weapon = window.gameState.lastMergedWeapon; 
            const title = `Analyse d'Expert de ${weapon.name}`;
            openAIModal(title, "Analyse en cours... Veuillez patienter.");

            const userQuery = `Fournis une analyse strat√©gique pour l'arme suivante : Nom: ${weapon.name}, Niveau: ${weapon.level}, Raret√©: ${weapon.rarity}, Ic√¥ne: ${weapon.icon}. √âvalue ses forces et faiblesses dans un jeu RPG de fantaisie classique.`;
            const systemPrompt = "Tu es un analyste d'armes l√©gendaire. Ta r√©ponse doit √™tre en fran√ßais, concise, structur√©e en deux sections (Forces et Faiblesses), et doit aider le joueur √† comprendre l'arme strat√©giquement.";

            const result = await fetchGeminiResponse(userQuery, systemPrompt);
            document.getElementById('ai-modal-body').textContent = result;
        };
        
        // Fonction 2: G√©n√©ration du Lore/Histoire de l'arme
        window.generateWeaponLore = async (weaponId) => {
            const weapon = window.gameState.inventory.find(w => w.id === weaponId) || 
                           window.gameState.grid.find(w => w && w.id === weaponId);
            
            if (!weapon) return;

            const cost = 25;
            if (window.gameState.money < cost) {
                showMessage(`Il vous faut ${cost} üí∞ pour g√©n√©rer une histoire.`);
                return;
            }
            
            if (window.gameState.aiAnalysisHistory[weapon.id]) {
                openAIModal(`L√©gende de ${weapon.name} (Archiv√©e)`, window.gameState.aiAnalysisHistory[weapon.id]);
                return;
            }


            window.gameState.money -= cost;
            window.saveGameState(window.gameState);
            window.renderApp(); 

            const title = `L√©gende de ${weapon.name}`;
            openAIModal(title, "G√©n√©ration de l'histoire en cours... L'IA imagine son pass√©.");

            const userQuery = `Invente une l√©gende √©pique ou une histoire courte (maximum 100 mots) sur l'origine de cette arme : Nom: ${weapon.name}, Niveau: ${weapon.level}, Raret√©: ${weapon.rarity}, Ic√¥ne: ${weapon.icon}. L'histoire doit correspondre √† sa raret√©.`;
            const systemPrompt = "Tu es un conteur mystique. R√©dige une l√©gende captivante en fran√ßais et donne-lui un ton qui correspond √† la raret√© de l'arme (Commune, Rare, L√©gendaire). Ne te contente pas de lister les caract√©ristiques.";

            const result = await fetchGeminiResponse(userQuery, systemPrompt);
            
            window.gameState.aiAnalysisHistory[weapon.id] = result;
            window.saveGameState(window.gameState);

            document.getElementById('ai-modal-body').textContent = result;
        };

        // Fonction 3: Conseil Strat√©gique du Ma√Ætre Forgeron (Nouveau)
        window.getMentorAdvice = async () => {
            const cost = 75;
            if (window.gameState.money < cost) {
                showMessage(`Il vous faut ${cost} üí∞ pour l'avis strat√©gique du Ma√Ætre Forgeron.`);
                return;
            }

            window.gameState.money -= cost;
            window.saveGameState(window.gameState);
            window.renderApp(); 

            const title = `Conseil du Ma√Ætre Forgeron`;
            openAIModal(title, "Le Ma√Ætre Forgeron r√©fl√©chit √† votre strat√©gie...");

            // Formater l'√©tat du jeu pour l'IA
            const gridWeapons = window.gameState.grid.filter(w => w !== null).map(w => `${w.name} (Lv ${w.level})`).join(', ') || 'Aucune arme sur la grille.';
            const inventoryWeapons = window.gameState.inventory.map(w => `${w.name} (Lv ${w.level})`).join(', ') || 'Inventaire vide.';
            
            const userQuery = `Voici l'√©tat actuel de ma forge :
                - Niveau du joueur: ${window.gameState.level}
                - Argent disponible: ${window.gameState.money} üí∞
                - Armes sur la Grille (9 emplacements): ${gridWeapons}
                - Armes dans l'Inventaire (${window.gameState.inventory.length}/${MAX_INVENTORY_SIZE}): ${inventoryWeapons}
                
                Donne-moi un conseil strat√©gique pour optimiser ma progression (fusionner, placer, ou am√©liorer). Sois direct et encourageant.`;
            
            const systemPrompt = "Tu es un Ma√Ætre Forgeron l√©gendaire et un mentor. Tu dois analyser la liste des armes et fournir un seul conseil strat√©gique clair et actionable pour aider le joueur √† progresser ou √† am√©liorer son score. Ta r√©ponse doit √™tre en fran√ßais et ne doit pas d√©passer trois phrases.";

            const result = await fetchGeminiResponse(userQuery, systemPrompt);
            document.getElementById('ai-modal-body').textContent = result;
        };

        // --- Utilitaires de Message/Toast ---
        let messageTimeout;
        const showMessage = (text) => {
            const messageEl = document.getElementById('message-box');
            if (!messageEl) return;
            
            messageEl.textContent = text;
            messageEl.classList.remove('opacity-0', 'scale-90', 'hidden');
            messageEl.classList.add('opacity-100', 'scale-100');
            
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                messageEl.classList.remove('opacity-100', 'scale-100');
                messageEl.classList.add('opacity-0', 'scale-90');
                setTimeout(() => messageBox.classList.add('hidden'), 500);
            }, 3000);
        };

        // --- Fonctions de Rendu de Vue ---

        window.submitUserName = () => {
            const input = document.getElementById('username-input');
            const userName = input.value.trim();
            if (userName.length < 2) {
                showMessage("Le nom d'utilisateur doit contenir au moins 2 caract√®res.");
                return;
            }
            window.gameState.userName = userName;
            changeView('menu'); // Aller au menu principal apr√®s la saisie du nom
        };

        const changeView = (viewName, fromView = null) => {
            if (viewName === 'game') {
                if (!window.gameState.stats.spawnIntervalId) {
                    window.startSpawnInterval();
                }
                // Spawn initial seulement si la grille ET l'inventaire sont vides
                if (window.gameState.inventory.length === 0 && window.gameState.grid.every(slot => slot === null)) {
                    spawnWeapon(1); 
                    spawnWeapon(1); 
                }
            } else {
                 stopSpawnInterval();
            }
            
            window.gameState.view = viewName;
            window.saveGameState(window.gameState);
            
            window.startMusic(); // D√©marre la musique si elle ne l'est pas
            window.renderApp();
        };

        const renderNameInput = () => `
            <div class="flex flex-col items-center justify-center flex-grow p-8">
                <h1 class="text-4xl font-extrabold text-yellow-400 mb-12 shadow-text">Bienvenue Forgeron!</h1>
                
                <div class="w-full max-w-xs mb-8">
                    <label for="username-input" class="block text-white text-lg font-semibold mb-2">Entrez votre nom :</label>
                    <input type="text" id="username-input" placeholder="Votre nom d'aventurier/√®re"
                           class="w-full p-3 rounded-lg bg-gray-700 text-white border border-gray-600 focus:ring-2 focus:ring-purple-500"
                           value="${window.gameState.userName}" maxlength="20">
                </div>
                
                <button onclick="submitUserName()" class="w-full max-w-xs p-4 text-xl font-bold text-white bg-green-600 rounded-lg shadow-xl hover:bg-green-700 transition transform hover:scale-[1.02]">
                    Commencer l'Aventure
                </button>
            </div>
        `;

        const renderMainMenu = () => `
            <div class="flex flex-col items-center justify-center flex-grow p-8">
                <h1 class="text-4xl font-extrabold text-yellow-400 mb-2 shadow-text">Salut, ${window.gameState.userName}!</h1>
                <p class="text-sm text-gray-400 mb-10">Forge de l'√Çme (Mode Solo)</p>
                
                <button onclick="changeView('game')" class="w-full max-w-xs p-4 mb-4 text-xl font-bold text-white bg-green-600 rounded-lg shadow-xl hover:bg-green-700 transition transform hover:scale-[1.02]">
                    D√©marrer/Reprendre la Forge
                </button>
                
                <!-- Le bouton Boutique & Am√©liorations a √©t√© retir√©, comme demand√© -->
                
                <button onclick="changeView('settings')" class="w-full max-w-xs p-3 mb-6 text-lg font-semibold text-white bg-blue-600 rounded-lg shadow-md hover:bg-blue-700 transition">
                    Param√®tres
                </button>
                
                <p class="mt-8 text-sm text-gray-500">ID Utilisateur: <span class="font-mono text-xs">${window.userId || 'Non connect√©'}</span></p>
            </div>
        `;
        
        const renderSettings = () => `
            <div class="p-6 flex flex-col flex-grow">
                <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-3">
                    <h2 class="text-3xl font-bold text-white">Param√®tres</h2>
                    <button onclick="changeView('menu')" class="p-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition shadow-lg">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-home"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
                    </button>
                </div>
                
                <div class="mb-8">
                    <label for="volume-slider" class="text-lg font-semibold text-white block mb-2">Volume de la Musique</label>
                    <input type="range" id="volume-slider" min="0" max="1" step="0.01" value="${window.gameState.musicVolume}" 
                           oninput="updateMusicVolume(parseFloat(this.value))"
                           class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer range-lg">
                    <div class="text-sm text-gray-400 mt-1">${(window.gameState.musicVolume * 100).toFixed(0)}%</div>
                </div>

                <div class="flex-grow"></div>

                <!-- Ancien bouton retour retir√©, remplac√© par l'ic√¥ne en haut √† droite -->
            </div>
        `;

        const renderWeaponItem = (weapon, index, isInventory) => {
            if (!weapon) return `<div class="grid-slot p-2 bg-gray-800 rounded-md flex items-center justify-center" data-index="${index}"></div>`;
            
            const source = isInventory ? 'inventory' : index;
            const indexValue = isInventory ? 'inventory' : index;
            
            const loreExists = window.gameState.aiAnalysisHistory[weapon.id];
            
            // Le bouton Lore est seulement sur les armes dans l'inventaire
            const loreButton = !isInventory ? '' : `
                <button onclick="generateWeaponLore('${weapon.id}')" 
                        class="ai-button absolute bottom-0 right-0 p-1 rounded-tr-none rounded-bl-lg rounded-tl-sm rounded-br-lg text-xs hover:scale-[1.05] transition-transform z-10 
                        ${loreExists ? 'bg-yellow-600 text-gray-900 shadow-yellow-800' : 'bg-purple-600 text-white shadow-purple-800'}">
                    ‚ú®
                </button>
            `;

            return `
                <div class="weapon-item grid-slot ${weapon.bg} rounded-xl shadow-lg border-2 border-gray-600 flex flex-col items-center justify-center p-2 relative ${weapon.color} text-center transition" 
                     data-id="${weapon.id}" 
                     data-level="${weapon.level}"
                     data-index="${index}"
                     onmousedown="startDrag(event, '${weapon.id}', '${source}', '${indexValue}')" 
                     ontouchstart="startDrag(event, '${weapon.id}', '${source}', '${indexValue}')">
                    <div class="text-6xl mb-1">${weapon.icon}</div> 
                    <div class="text-xs font-bold whitespace-nowrap overflow-hidden text-ellipsis">${weapon.name}</div>
                    <div class="text-[10px] ${weapon.color.replace('400', '200')} font-medium">${weapon.rarity} Lv.${weapon.level}</div>
                    ${loreButton}
                </div>
            `;
        };
        
        const renderInventory = (inventory) => {
            const emptySlots = MAX_INVENTORY_SIZE - inventory.length;
            const inventoryHtml = inventory.map(weapon => renderWeaponItem(weapon, 'inventory', true)).join('');
            const emptySlotsHtml = Array(emptySlots).fill(null).map((_, index) => `<div class="inventory-slot p-2 bg-gray-700 rounded-md flex items-center justify-center text-gray-500 text-lg">vide</div>`).join('');

            return `
                <div class="flex space-x-2 overflow-x-auto p-2">
                    ${inventoryHtml}
                    ${emptySlotsHtml}
                </div>
            `;
        };
        
        const renderShop = () => {
            return `
                <div class="p-6 flex flex-col flex-grow">
                    <div class="flex justify-between items-center mb-6 border-b border-gray-700 pb-3">
                        <h2 class="text-3xl font-bold text-white">Boutique & Am√©liorations</h2>
                        <button onclick="changeView('game')" class="p-2 bg-red-600 text-white rounded-full hover:bg-red-700 transition shadow-lg" title="Retour au jeu">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-swords"><polyline points="14.5 17.5 17 20 19.5 17.5"/><path d="M5.5 13.5 3 11l2.5-2.5"/><path d="M22 2L15 9"/><path d="M2 22 9 15"/></svg>
                        </button>
                    </div>
                    
                    <div class="text-gray-300 mb-6">
                        <p class="text-lg font-semibold">üí∞ ${window.gameState.money} Pi√®ces d'Or</p>
                        <p class="text-sm text-gray-400">D√©pensez votre argent pour am√©liorer votre forge et votre chance de trouver des objets rares.</p>
                    </div>

                    <div class="space-y-4 flex-grow">
                        <!-- Am√©lioration 1: Vitesse de Spawn -->
                        <div class="bg-gray-700 p-4 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold text-yellow-300">Vitesse de Spawn</h3>
                            <p class="text-sm text-gray-400 mb-2">R√©duit le temps entre l'apparition des nouvelles armes (actuel: ${window.gameState.stats.spawnSpeed / 1000}s).</p>
                            <button class="w-full p-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
                                Acheter (150 üí∞)
                            </button>
                        </div>
                        
                        <!-- Am√©lioration 2: Chance de Raret√© -->
                        <div class="bg-gray-700 p-4 rounded-xl shadow-md">
                            <h3 class="text-xl font-bold text-purple-300">Chance de Raret√©</h3>
                            <p class="text-sm text-gray-400 mb-2">Augmente la probabilit√© d'apparition d'armes de haut niveau (actuel: ${(window.gameState.stats.rareChance * 100).toFixed(1)}%).</p>
                            <button class="w-full p-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 transition">
                                Acheter (200 üí∞)
                            </button>
                        </div>
                        
                        <p class="text-center text-gray-500 mt-8">Plus d'am√©liorations √† venir !</p>
                    </div>
                </div>
            `;
        };

        const renderGame = () => {
            const { userName, level, xp, xpToNextLevel, money, grid, inventory, stats, isMusicPlaying } = window.gameState;
            const xpPercent = Math.min(100, (xp / xpToNextLevel) * 100);

            return `
                <div class="flex flex-col flex-grow overflow-hidden p-3 pt-4">
                    <!-- Barre Sup√©rieure : Nom, Niveau, XP, Argent et Boutons de navigation -->
                    <div class="flex flex-col mb-4">
                        <div class="flex justify-between items-start mb-2">
                            <h1 class="text-xl font-bold text-white">Forge de ${userName}</h1>
                            <div class="flex items-center space-x-2">
                                <!-- Bouton Conseil Ma√Ætre Forgeron (NOUVEAU) -->
                                <button onclick="getMentorAdvice()" 
                                        class="p-2 bg-yellow-600 text-gray-900 rounded-full text-sm font-semibold shadow-md hover:bg-yellow-700 transition"
                                        title="Conseil strat√©gique du Ma√Ætre Forgeron (75 üí∞)">
                                    ‚ú®
                                </button>
                                <!-- Bouton Musique -->
                                <button onclick="toggleMusic()" class="p-2 bg-blue-600 text-white rounded-full text-sm font-semibold shadow-md hover:bg-blue-700 transition">
                                    ${isMusicPlaying 
                                        ? `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-2"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><path d="M15.54 8.46a5 5 0 0 1 0 7.07"/><path d="M19.07 4.93a10 10 0 0 1 0 14.14"/></svg>` 
                                        : `<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-volume-x"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"/><line x1="22" x2="16" y1="9" y2="15"/><line x1="16" x2="22" y1="9" y2="15" transform="rotate(90 19 12)"/></svg>`}
                                </button>
                                <!-- Bouton Boutique -->
                                <button onclick="changeView('shop')" class="p-2 bg-purple-600 text-white rounded-full text-sm font-semibold shadow-md hover:bg-purple-700 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-gem"><path d="M6 3v12l6 6 6-6V3"/><path d="M12 21V3"/><path d="M2 11h20"/></svg>
                                </button>
                                <!-- Bouton Menu Principal (Param√®tres) -->
                                <button onclick="changeView('menu')" class="p-2 bg-red-600 text-white rounded-full text-sm font-semibold shadow-md hover:bg-red-700 transition">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-menu"><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></svg>
                                </button>
                            </div>
                        </div>
                        <div class="flex justify-between items-center text-yellow-400 font-bold text-lg mb-2">
                            <span>Niveau ${level}</span>
                            <span>üí∞ ${money}</span>
                        </div>
                        <div class="w-full bg-gray-700 rounded-full h-2.5">
                            <div class="bg-yellow-500 h-2.5 rounded-full transition-all duration-300" style="width: ${xpPercent}%"></div>
                        </div>
                        <div class="text-[10px] text-gray-400 mt-0.5">${xp} / ${xpToNextLevel} XP</div>
                    </div>

                    <!-- Grille de Jeu (Le Carr√©) -->
                    <div class="flex justify-center items-center p-2 bg-gray-900 rounded-2xl shadow-inner mb-4">
                        <div id="game-grid-container" class="game-grid w-full">
                            ${grid.map((weapon, index) => renderWeaponItem(weapon, index, false)).join('')}
                        </div>
                    </div>

                    <!-- Zone d'Inventaire (Armes √† d√©poser) -->
                    <div class="mt-auto p-3 bg-gray-800 rounded-xl shadow-inner">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-white font-semibold">Inventaire (${inventory.length}/${MAX_INVENTORY_SIZE})</h3>
                            <button onclick="analyzeLastWeapon()" 
                                    class="ai-button p-2 text-xs bg-purple-700 text-white rounded-lg hover:bg-purple-800"
                                    title="Analyse de la derni√®re arme fusionn√©e (50 üí∞)">
                                ANALYSE (50 üí∞)
                            </button>
                        </div>
                        ${renderInventory(inventory)}
                    </div>

                    <!-- Message Box (Toast) -->
                    <div id="message-box" class="hidden fixed bottom-16 left-1/2 transform -translate-x-1/2 p-3 bg-indigo-600 text-white rounded-lg shadow-xl text-sm font-semibold transition-all duration-500 opacity-0 scale-90 z-50">
                        Message test
                    </div>
                </div>
            `;
        };
        
        // --- Fonction Principale de Rendu de l'Application ---
        
        const renderAppContent = () => {
            switch (window.gameState.view) {
                case 'name_input':
                    return renderNameInput();
                case 'menu':
                    return renderMainMenu();
                case 'game':
                    return renderGame();
                case 'settings':
                    return renderSettings();
                case 'shop':
                    return renderShop();
                default:
                    return `<div class="flex-grow flex items-center justify-center text-white text-lg">Vue inconnue: ${window.gameState.view}</div>`;
            }
        };

        window.renderApp = () => {
            const appElement = document.getElementById('app');
            // La v√©rification window.isAuthReady est maintenue pour la s√©curit√©, mais est forc√©e √† true au d√©marrage.
            if (window.isAuthReady) {
                appElement.innerHTML = renderAppContent();
                // Assurez-vous que le listener Firestore est d√©marr√© si nous sommes pr√™ts et que nous n'en avons pas d√©j√† un
                if (window.userId && !window.unsubscribeSnapshot) {
                    window.loadAndListen();
                }
            } else {
                // Ce bloc ne devrait plus √™tre appel√©, car isAuthReady = true.
                appElement.innerHTML = `<div>Une erreur est survenue lors du chargement initial.</div>`;
            }
        };

        // Appel INITIAL pour d√©marrer imm√©diatement l'application (saisie du nom)
        if (window.isAuthReady) {
            window.renderApp();
        }

    </script>
</body>
</html>
